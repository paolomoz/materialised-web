# Image Mode Switching Guide

This document explains how to switch between RAG-based images and AI-generated images using Z-Image Turbo.

## Overview

The system supports two image modes:

| Mode | Description | Speed | Cost |
|------|-------------|-------|------|
| `generate` | Always generates images using AI (no exceptions) | ~0.5-1s per image | $0.005/megapixel |
| `rag` | Uses existing images from RAG, index, and product maps | Instant (cached) | Free |

## Current Configuration

The system is currently configured for **always-generate mode** using Z-Image Turbo:

```toml
# wrangler.toml
IMAGE_MODE = "generate"
IMAGE_PROVIDER = "zimage"
```

---

## How to Switch Between Modes

### Option 1: Always Generate Images (Current)

Edit `wrangler.toml`:

```toml
IMAGE_MODE = "generate"
IMAGE_PROVIDER = "zimage"
```

Then deploy:
```bash
npx wrangler deploy
```

**Behavior:**
- Every image is freshly generated by Z-Image Turbo
- No RAG/index lookups are performed
- Images stored in R2 bucket at `/images/{slug}/{image-id}.png`
- Cost: ~$0.005 per megapixel

### Option 2: RAG Images Only (To Switch Back)

Edit `wrangler.toml`:

```toml
IMAGE_MODE = "rag"
# IMAGE_PROVIDER is ignored when IMAGE_MODE="rag"
```

Then deploy:
```bash
npx wrangler deploy
```

**Behavior:**
- Images resolved from RAG chunks, image index, and product maps
- No AI generation occurs
- Falls back to placeholders if no image found
- Cost: Free (uses existing indexed images)

---

## Available Image Providers

When `IMAGE_MODE="generate"`, you can choose different providers:

### Z-Image Turbo (Recommended)
```toml
IMAGE_PROVIDER = "zimage"
```
- **Speed:** ~0.5-1s per image
- **Cost:** $0.005/megapixel
- **Quality:** High
- **API:** https://fal.ai/models/fal-ai/z-image/turbo

### FLUX Schnell
```toml
IMAGE_PROVIDER = "fal"
```
- **Speed:** ~0.8-1s per image
- **Cost:** $0.003/megapixel
- **Quality:** Medium

### FLUX Dev with LoRA
```toml
IMAGE_PROVIDER = "lora"
```
- **Speed:** ~3-5s per image
- **Cost:** $0.003/megapixel
- **Quality:** High (brand-consistent with Vitamix LoRA)

### Google Imagen 3
```toml
IMAGE_PROVIDER = "imagen"
```
- **Speed:** ~3-5s per image
- **Cost:** Vertex AI pricing
- **Quality:** Highest

---

## Implementation Details

### Files Modified

| File | Purpose |
|------|---------|
| `src/ai-clients/zimage.ts` | Z-Image Turbo client for fal.ai |
| `src/ai-clients/image-router.ts` | Routes to appropriate provider |
| `src/types.ts` | Added `IMAGE_MODE` and `zimage` provider types |
| `src/lib/orchestrator.ts` | Added `generateImagesInBackground()` function |
| `wrangler.toml` | Configuration variables |

### Environment Variables

```toml
# Required for generate mode
IMAGE_MODE = "generate" | "rag"

# Only used when IMAGE_MODE="generate"
IMAGE_PROVIDER = "zimage" | "fal" | "lora" | "imagen"
```

### Secrets Required

For Z-Image Turbo (and other fal.ai providers):
```bash
npx wrangler secret put FAL_API_KEY
# Enter your fal.ai API key
```

For Google Imagen 3:
```bash
npx wrangler secret put GOOGLE_SERVICE_ACCOUNT_JSON
# Enter your service account JSON
```

---

## How It Works

### Generate Mode Flow

```
Content Generated
       ↓
buildImageRequestsForGeneration()
       ↓
generateImagesInBackground()
       ↓
generateImages() via image-router
       ↓
generateImagesWithZImage()
       ↓
fal.ai z-image/turbo API
       ↓
Download image → Store in R2
       ↓
Emit 'image-ready' SSE event
```

### RAG Mode Flow

```
Content Generated
       ↓
collectImageRequests()
       ↓
resolveImagesInBackground()
       ↓
findBestImage() for each request
       ↓
1. Check product image map
2. Check RAG chunk metadata
3. Query IMAGE_INDEX vectorize
       ↓
Emit 'image-ready' SSE event (or leave placeholder)
```

---

## Quick Commands

### Deploy with Z-Image Generation
```bash
# Ensure wrangler.toml has:
# IMAGE_MODE = "generate"
# IMAGE_PROVIDER = "zimage"

npx wrangler deploy
```

### Switch to RAG Mode
```bash
# Edit wrangler.toml to set:
# IMAGE_MODE = "rag"

npx wrangler deploy
```

### Check Current Configuration
```bash
grep -E "IMAGE_MODE|IMAGE_PROVIDER" wrangler.toml
```

### View Worker Logs
```bash
npx wrangler tail
```

---

## Troubleshooting

### Images not generating
1. Check `FAL_API_KEY` secret is set: `npx wrangler secret list`
2. Check worker logs: `npx wrangler tail`
3. Verify `IMAGE_MODE = "generate"` in wrangler.toml

### Images show as placeholders locally
- Expected behavior - local dev server can't access R2 bucket
- Test via deployed worker URL to see actual images

### Wrong provider being used
- Check logs for `[ImageRouter] ACTUALLY USING:` message
- Verify `IMAGE_PROVIDER` setting in wrangler.toml
- Redeploy after changes: `npx wrangler deploy`

---

## Cost Estimation

For a typical page with 8 images (1 hero + 6 cards + 1 technique):

| Provider | Images | Est. Megapixels | Est. Cost |
|----------|--------|-----------------|-----------|
| Z-Image | 8 | ~6 MP | ~$0.03 |
| FLUX Schnell | 8 | ~6 MP | ~$0.02 |
| FLUX LoRA | 8 | ~6 MP | ~$0.02 |
| RAG | 8 | 0 | $0.00 |

---

## Related Documentation

- [IMAGE_STRATEGY.md](./IMAGE_STRATEGY.md) - Overall image strategy and RAG improvements
- [fal.ai Z-Image Turbo](https://fal.ai/models/fal-ai/z-image/turbo) - API documentation
