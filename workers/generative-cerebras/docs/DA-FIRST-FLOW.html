<!DOCTYPE html>
<html>
<head>
<meta
  http-equiv="Content-Security-Policy"
  content="script-src 'nonce-aem' 'strict-dynamic' 'unsafe-inline' http: https:; base-uri 'self'; object-src 'none'; connect-src 'self' https://vitamix-generative.paolo-moz.workers.dev https://vitamix-generative-cerebras.paolo-moz.workers.dev;"
  move-to-http-header="true"
>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script nonce="aem" src="/scripts/aem.js" type="module"></script>
<script nonce="aem" src="/scripts/scripts.js" type="module"></script>
<script nonce="aem" src="/scripts/cerebras-scripts.js" type="module"></script>
<link rel="stylesheet" href="/styles/styles.css"/>
<link rel="stylesheet" href="/styles/skeleton.css"/>
</head>
<body>
<header></header>
<main>
<div><h1 id="da-first-flow-architecture">DA-First Flow Architecture</h1>
<blockquote>
<p><strong>Status</strong>: Implemented but reverted. Saved for future reference.</p>
</blockquote>
<h2 id="overview">Overview</h2>
<p>This flow creates a DA (Document Authoring) page first, then streams content into it on first render.</p>
<h2 id="user-journey">User Journey</h2>
<ol>
<li>User on homepage enters query, clicks "Explore"</li>
<li>Frontend calls <code>POST /api/create-page</code> with <code>{ query, images }</code></li>
<li>Worker:
<ul>
<li>Classifies intent using Cerebras (~200ms)</li>
<li>Determines category (<code>smoothies</code>, <code>recipes</code>, <code>compare</code>, etc.)</li>
<li>Generates semantic slug</li>
<li>Creates placeholder DA page with <code>cerebras-generated</code> block</li>
<li>Returns <code>{ path }</code> to frontend</li>
</ul>
</li>
<li>Frontend redirects to DA page (e.g., <code>/smoothies/green-smoothie-abc123</code>)</li>
<li>DA page loads, <code>cerebras-generated</code> block:
<ul>
<li>Reads query/slug from page metadata</li>
<li>Connects to worker SSE stream</li>
<li>Renders blocks progressively as they arrive</li>
<li>Shows shimmer placeholders for images</li>
</ul>
</li>
<li>Images load asynchronously via <code>image-ready</code> events</li>
<li>Content persists to DA after generation completes</li>
</ol>
<h2 id="key-components">Key Components</h2>
<h3 id="worker-endpoint-apicreate-page">Worker Endpoint: <code>/api/create-page</code></h3>
<pre><code class="language-typescript">// POST /api/create-page
// Body: { query: string, images: 'fal' | 'imagen' }
// Returns: { path: string, slug: string }

async function handleCreatePage(request: Request, env: Env): Promise&#x3C;Response> {
  const { query, images } = await request.json();

  // 1. Classify intent
  const intent = await classifyIntent(query, env);

  // 2. Determine category and path
  const category = classifyCategory(intent, query);
  const slug = generateSemanticSlug(query, intent);
  const path = buildCategorizedPath(category, slug);

  // 3. Create placeholder DA page
  await createPlaceholderPage(path, query, slug, env, sourceOrigin, imageProvider);

  // 4. Return path for redirect
  return Response.json({ path, slug });
}
</code></pre>
<h3 id="placeholder-page-html">Placeholder Page HTML</h3>
<pre><code class="language-html">&#x3C;!DOCTYPE html>
&#x3C;html>
&#x3C;head>
  &#x3C;title>Creating Your Page | Vitamix&#x3C;/title>
  &#x3C;meta name="cerebras-query" content="green smoothie recipes">
  &#x3C;meta name="cerebras-slug" content="green-smoothie-abc123">
  &#x3C;meta name="cerebras-source" content="https://main--site--org.aem.page">
  &#x3C;meta name="cerebras-images" content="fal">
&#x3C;/head>
&#x3C;body>
  &#x3C;header>&#x3C;/header>
  &#x3C;main>
    &#x3C;div>
      &#x3C;div class="cerebras-generated">
        &#x3C;div>&#x3C;div>green smoothie recipes&#x3C;/div>&#x3C;/div>
        &#x3C;div>&#x3C;div>green-smoothie-abc123&#x3C;/div>&#x3C;/div>
      &#x3C;/div>
    &#x3C;/div>
  &#x3C;/main>
  &#x3C;footer>&#x3C;/footer>
&#x3C;/body>
&#x3C;/html>
</code></pre>
<h3 id="cerebras-generated-block">cerebras-generated Block</h3>
<p>Located at <code>blocks/cerebras-generated/</code></p>
<pre><code class="language-javascript">export default async function decorate(block) {
  // Read from block content or metadata
  const query = /* from block or meta */;
  const slug = /* from block or meta */;
  const imageProvider = document.querySelector('meta[name="cerebras-images"]')?.content || 'fal';

  // Show loading state
  block.innerHTML = `&#x3C;div class="cerebras-loading">...&#x3C;/div>`;

  // Connect to SSE stream
  const streamUrl = `${WORKER_URL}/api/stream?slug=${slug}&#x26;query=${query}&#x26;images=${imageProvider}`;
  const eventSource = new EventSource(streamUrl);

  eventSource.addEventListener('block-content', (e) => {
    // Render block progressively
  });

  eventSource.addEventListener('image-ready', (e) => {
    // Replace placeholder with real image
  });
}
</code></pre>
<h3 id="category-classifier">Category Classifier</h3>
<p>Maps intents to URL categories:</p>

































<div class="intent"><div><div>smoothie_recipes</div><div>/smoothies/</div></div><div><div>food_recipes</div><div>/recipes/</div></div><div><div>product_comparison</div><div>/compare/</div></div><div><div>product_info</div><div>/products/</div></div><div><div>tips_techniques</div><div>/tips/</div></div><div><div>* (default)</div><div>/discover/</div></div></div>
<h3 id="frontend-changes">Frontend Changes</h3>
<pre><code class="language-javascript">async function startGeneration(query) {
  // Call API to create DA page
  const response = await fetch(`${WORKER_URL}/api/create-page`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, images: imageProvider }),
  });

  const { path } = await response.json();

  // Redirect to DA page
  window.location.href = path;
}
</code></pre>
<h2 id="benefits">Benefits</h2>
<ol>
<li><strong>Clean URLs</strong>: <code>/smoothies/green-smoothie-abc123</code> instead of <code>/?cerebras=...</code></li>
<li><strong>SEO-friendly</strong>: Content at permanent, categorized paths</li>
<li><strong>Shareable</strong>: Users can share the DA page URL</li>
<li><strong>Persistent</strong>: Content saved to DA system</li>
</ol>
<h2 id="drawbacks">Drawbacks</h2>
<ol>
<li><strong>Slower initial response</strong>: Need to create DA page before redirect (~2s)</li>
<li><strong>More complex</strong>: Multiple systems involved (DA API, AEM Admin)</li>
<li><strong>Requires DA credentials</strong>: Worker needs DA_TOKEN, DA_ORG, DA_REPO</li>
</ol>
<h2 id="future-optimization">Future Optimization</h2>
<p>Could use <code>waitUntil()</code> to start generation in background while creating DA page, then buffer blocks in KV for the stream to replay. Would save ~2 seconds.</p>
<h2 id="files-changed">Files Changed</h2>
<ul>
<li><code>workers/generative-cerebras/src/index.ts</code> - <code>/api/create-page</code> endpoint</li>
<li><code>workers/generative-cerebras/src/lib/da-client.ts</code> - <code>createPlaceholderPage()</code></li>
<li><code>workers/generative-cerebras/src/lib/category-classifier.ts</code> - Intent mapping</li>
<li><code>blocks/cerebras-generated/</code> - First-render streaming block</li>
<li><code>blocks/query-form-cerebras/</code> - Updated to use API</li>
<li><code>scripts/cerebras-scripts.js</code> - Updated to use API</li>
</ul></div>
</main>
<footer></footer>
</body>
</html>