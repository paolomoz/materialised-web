<!DOCTYPE html>
<html>
<head>
<meta
  http-equiv="Content-Security-Policy"
  content="script-src 'nonce-aem' 'strict-dynamic' 'unsafe-inline' http: https:; base-uri 'self'; object-src 'none'; connect-src 'self' https://vitamix-generative.paolo-moz.workers.dev https://vitamix-generative-cerebras.paolo-moz.workers.dev;"
  move-to-http-header="true"
>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script nonce="aem" src="/scripts/aem.js" type="module"></script>
<script nonce="aem" src="/scripts/scripts.js" type="module"></script>
<script nonce="aem" src="/scripts/cerebras-scripts.js" type="module"></script>
<link rel="stylesheet" href="/styles/styles.css"/>
<link rel="stylesheet" href="/styles/skeleton.css"/>
</head>
<body>
<header></header>
<main>
<div><h1 id="layout-selection-strategy">Layout Selection Strategy</h1>
<p>This document describes how the generative page system selects the appropriate layout template for a user query.</p>
<h2 id="overview">Overview</h2>
<p>The layout selection process has three stages:</p>
<ol>
<li><strong>LLM Intent Classification</strong> - Classifies query and suggests a layout</li>
<li><strong>Rule-Based Selection</strong> - Fallback logic when LLM confidence is low</li>
<li><strong>Post-RAG Adjustment</strong> - Adjusts layout based on retrieved content</li>
</ol>
<pre><code>┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  User Query     │────▶│  LLM Classifies  │────▶│  RAG Retrieval  │
└─────────────────┘     │  Intent + Layout │     └────────┬────────┘
                        └────────┬─────────┘              │
                                 │                        │
                        ┌────────▼─────────┐     ┌────────▼────────┐
                        │  getLayoutFor    │────▶│  adjustLayout   │
                        │  Intent()        │     │  ForRAGContent()│
                        └──────────────────┘     └────────┬────────┘
                                                          │
                                                 ┌────────▼────────┐
                                                 │  Final Layout   │
                                                 └─────────────────┘
</code></pre>
<h2 id="available-layouts">Available Layouts</h2>











































































<div class="layout-id"><div><div><code>product-detail</code></div><div>Single product page</div><div>product-hero, specs-table, feature-highlights</div></div><div><div><code>product-comparison</code></div><div>Compare 2+ products</div><div>comparison-table, verdict-card</div></div><div><div><code>recipe-collection</code></div><div>Browse multiple recipes</div><div>recipe-grid, recipe-filter-bar, ingredient-search</div></div><div><div><code>single-recipe</code></div><div>One detailed recipe</div><div>recipe-hero, ingredients-list, recipe-steps</div></div><div><div><code>use-case-landing</code></div><div>Routine/habit focused</div><div>benefits-grid, recipe-cards, tips-banner</div></div><div><div><code>support</code></div><div>Troubleshooting</div><div>diagnosis-card, troubleshooting-steps</div></div><div><div><code>category-browse</code></div><div>Browse product category</div><div>product-cards, benefits-grid</div></div><div><div><code>educational</code></div><div>How-to content</div><div>text, columns, faq</div></div><div><div><code>promotional</code></div><div>Sales/offers</div><div>hero, cards, split-content</div></div><div><div><code>quick-answer</code></div><div>Simple factual answer</div><div>hero, text</div></div><div><div><code>lifestyle</code></div><div>Inspirational content</div><div>cards, split-content, columns</div></div><div><div><code>campaign-landing</code></div><div>Seasonal/event campaigns</div><div>countdown-timer, testimonials</div></div><div><div><code>about-story</code></div><div>Brand/company info</div><div>timeline, team-cards</div></div></div>
<h2 id="stage-1-llm-intent-classification">Stage 1: LLM Intent Classification</h2>
<p>The LLM classifies each query and outputs:</p>
<pre><code class="language-typescript">interface IntentClassification {
  intentType: 'product_info' | 'recipe' | 'comparison' | 'support' | 'general';
  confidence: number;        // 0.0 - 1.0
  layoutId: LayoutId;        // LLM's suggested layout
  contentTypes: ContentType[];
  entities: {
    products: string[];      // e.g., ["A3500", "Pro 750"]
    ingredients: string[];   // e.g., ["spinach", "banana"]
    goals: string[];         // e.g., ["morning routine", "meal prep"]
  };
}
</code></pre>
<h3 id="product-catalog">Product Catalog</h3>
<p>The prompt includes a known product list to prevent hallucinated product names:</p>
<ul>
<li><strong>Ascent Series</strong>: A3500, A2500, A2300</li>
<li><strong>Explorian Series</strong>: E310, E320</li>
<li><strong>Legacy Series</strong>: Pro 750, Pro 500, 5200, 5300, 7500</li>
<li><strong>Accessories</strong>: Self-Detect containers, Dry Grains container, etc.</li>
</ul>
<h3 id="disambiguation-examples">Disambiguation Examples</h3>
<p>The prompt includes explicit disambiguation tables to handle edge cases:</p>



































<div class="query"><div><div>"Green smoothie recipe"</div><div>single-recipe</div><div>Singular = specific recipe</div></div><div><div>"Green smoothie recipes"</div><div>recipe-collection</div><div>Plural = multiple</div></div><div><div>"I drink smoothies every morning"</div><div>use-case-landing</div><div>Routine pattern</div></div><div><div>"A3500 vs A2500"</div><div>product-comparison</div><div>Explicit "vs"</div></div><div><div>"Best Vitamix blender"</div><div>product-comparison</div><div>Superlative = comparison</div></div></div>
<h2 id="stage-2-rule-based-selection">Stage 2: Rule-Based Selection</h2>
<pre><code class="language-typescript">function getLayoutForIntent(
  intentType: string,
  contentTypes: string[],
  entities: { products: string[]; goals: string[]; ingredients?: string[] },
  llmLayoutId?: string,    // LLM's suggested layout
  confidence?: number      // LLM's confidence score
): LayoutTemplate
</code></pre>
<h3 id="confidence-threshold">Confidence Threshold</h3>
<p>When LLM confidence is <strong>≥ 0.85</strong>, the LLM's layout choice is trusted directly:</p>
<pre><code class="language-typescript">if (llmLayoutId &#x26;&#x26; confidence >= 0.85) {
  const layout = getLayoutById(llmLayoutId);
  if (layout) return layout;  // Trust LLM
}
// Otherwise, apply rule-based fallback
</code></pre>
<h3 id="rule-based-fallback">Rule-Based Fallback</h3>
<p>When confidence is low or LLM choice is invalid:</p>
<pre><code>1. support intent → LAYOUT_SUPPORT
2. comparison intent → LAYOUT_PRODUCT_COMPARISON
3. product_info + 1 product → LAYOUT_PRODUCT_DETAIL
4. product_info + 0 products → LAYOUT_CATEGORY_BROWSE
5. recipe intent:
   - Single recipe patterns → LAYOUT_SINGLE_RECIPE
   - Use-case patterns → LAYOUT_USE_CASE_LANDING
   - Otherwise → LAYOUT_RECIPE_COLLECTION
6. Campaign patterns → LAYOUT_CAMPAIGN_LANDING
7. About patterns → LAYOUT_ABOUT_STORY
8. support/editorial content → LAYOUT_EDUCATIONAL
9. Default → LAYOUT_LIFESTYLE
</code></pre>
<h3 id="semantic-pattern-matching">Semantic Pattern Matching</h3>
<p>Instead of simple <code>includes()</code> checks, regex patterns prevent false positives:</p>
<h4 id="use-case-patterns-triggers-use-case-landing">Use-Case Patterns (triggers <code>use-case-landing</code>)</h4>
<pre><code class="language-javascript">/every\s+(morning|day|week|night|evening)/i    // "every morning"
/daily\s+(routine|habit|use|smoothie|juice)/i  // "daily routine"
/(morning|evening)\s+routine/i                  // "morning routine"
/meal\s+prep/i                                  // "meal prep"
/start\s+(my|the|your)\s+(day|morning)/i       // "start my day"
/each\s+(morning|day|week)/i                   // "each morning"
</code></pre>
<h4 id="single-recipe-patterns-triggers-single-recipe">Single Recipe Patterns (triggers <code>single-recipe</code>)</h4>
<pre><code class="language-javascript">/how\s+(do\s+i|to|can\s+i)\s+make/i   // "how to make"
/recipe\s+for\s+\w+/i                  // "recipe for hummus"
/make\s+(a|me|some)\s+\w+/i            // "make me a smoothie"
/\w+\s+recipe$/i                       // "hummus recipe"
</code></pre>
<h4 id="campaign-patterns-triggers-campaign-landing">Campaign Patterns (triggers <code>campaign-landing</code>)</h4>
<pre><code class="language-javascript">/mother'?s?\s*day/i                              // "Mother's Day"
/black\s*friday/i                                // "Black Friday"
/(christmas|holiday)\s*(gift|deal|sale)?/i       // "Christmas gifts"
/(summer|winter)\s+(sale|special|campaign)/i     // "summer sale"
/\b(gift\s+guide|gift\s+ideas?)\b/i             // "gift guide"
</code></pre>
<h3 id="why-patterns--keywords">Why Patterns > Keywords</h3>



































<div class="query"><div><div>"What can I prep?"</div><div>use-case-landing ❌</div><div>recipe-collection ✓</div></div><div><div>"Recipes any morning"</div><div>use-case-landing ❌</div><div>recipe-collection ✓</div></div><div><div>"Daily vitamins smoothie"</div><div>use-case-landing ❌</div><div>recipe-collection ✓</div></div><div><div>"Every type of soup"</div><div>use-case-landing ❌</div><div>recipe-collection ✓</div></div><div><div>"Start my day healthy"</div><div>recipe-collection ❌</div><div>use-case-landing ✓</div></div></div>
<h2 id="stage-3-post-rag-adjustment">Stage 3: Post-RAG Adjustment</h2>
<p>After RAG retrieval, the layout is adjusted based on what content was actually found:</p>
<pre><code class="language-typescript">function adjustLayoutForRAGContent(
  layout: LayoutTemplate,
  ragContext: {
    hasProductInfo: boolean;
    hasRecipes: boolean;
    chunks: Array&#x3C;{ metadata: { content_type: string } }>;
  }
): LayoutTemplate
</code></pre>
<h3 id="adjustment-rules">Adjustment Rules</h3>



































<div class="initial-layout"><div><div><code>single-recipe</code></div><div>No recipes found</div><div><code>educational</code></div></div><div><div><code>recipe-collection</code></div><div>No recipes found</div><div><code>lifestyle</code></div></div><div><div><code>product-detail</code></div><div>Multiple products</div><div><code>product-comparison</code></div></div><div><div><code>product-detail</code></div><div>No products</div><div><code>category-browse</code></div></div><div><div><code>category-browse</code></div><div>Single product</div><div><code>product-detail</code></div></div></div>
<h3 id="why-post-rag-adjustment">Why Post-RAG Adjustment?</h3>
<p>If user asks "tomato soup recipe" but no tomato soup recipe exists in the knowledge base:</p>
<ul>
<li><strong>Before</strong>: Empty single-recipe page with placeholder content</li>
<li><strong>After</strong>: Educational page with general soup-making tips</li>
</ul>
<h2 id="files">Files</h2>

























<div class="file"><div><div><code>src/prompts/intent.ts</code></div><div>Intent classification prompt with product catalog and disambiguation</div></div><div><div><code>src/prompts/layouts.ts</code></div><div>Layout templates, selection logic, and RAG adjustment</div></div><div><div><code>src/lib/orchestrator.ts</code></div><div>Wires together intent → layout → content generation</div></div><div><div><code>src/types.ts</code></div><div>TypeScript interfaces for IntentClassification, LayoutId, etc.</div></div></div>
<h2 id="adding-a-new-layout">Adding a New Layout</h2>
<ol>
<li>Define the layout template in <code>layouts.ts</code>:</li>
</ol>
<pre><code class="language-typescript">export const LAYOUT_NEW_TYPE: LayoutTemplate = {
  id: 'new-type',
  name: 'New Type',
  description: 'Description of when to use this layout',
  useCases: ['example query 1', 'example query 2'],
  sections: [/* block definitions */],
};
</code></pre>
<ol start="2">
<li>
<p>Add to <code>LAYOUTS</code> array in <code>layouts.ts</code></p>
</li>
<li>
<p>Add <code>layout_id</code> to intent prompt in <code>intent.ts</code></p>
</li>
<li>
<p>Add disambiguation examples if needed</p>
</li>
<li>
<p>Add pattern matching rules in <code>getLayoutForIntent()</code> if rule-based fallback is needed</p>
</li>
<li>
<p>Update <code>LayoutId</code> type in <code>types.ts</code></p>
</li>
</ol>
<h2 id="debugging">Debugging</h2>
<p>Layout selection logs to console:</p>
<pre><code>[Layout] Trusting LLM choice: product-detail (confidence: 0.95)
</code></pre>
<p>or</p>
<pre><code>[Layout] Using rule-based fallback (LLM confidence: 0.6)
[Layout Adjust] product-detail → category-browse (no products in RAG)
</code></pre>
<p>Check these logs to understand why a particular layout was selected.</p></div>
</main>
<footer></footer>
</body>
</html>